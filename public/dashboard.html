<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #191414; 
            color: #FFFFFF;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
        }

        h1 {
            font-size: 3rem;
            color: #1DB954; 
            margin-bottom: 20px;
        }

        button {
            font-size: 1.2rem;
            padding: 15px 30px;
            background-color: #1DB954; 
            color: #FFFFFF;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px 0;
            width: 250px;
            text-align: center;
        }

        button:hover {
            background-color: #1ed760; 
            transform: scale(1.05);
        }

        .dropdown {
            margin-top: 20px;
            width: 80%;
            max-width: 600px;
            background-color: #282828; 
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.5);
            display: none; 
        }

        ul {
            list-style: none;
            padding: 0;
        }

        li {
            font-size: 1.2rem;
            margin: 10px 0;
            color: #B3B3B3; 
            font-weight: bold;
        }

        .track-name {
            color: #FFFFFF; 
        }

        .artist-name {
            color: #FFFFFF; 
        }

        .genre-name {
            color: #FFFFFF; 
        }

        
    </style>
</head>
<body>
    <h1>Your Spotify Dashboard</h1>

    <button id="fetch-tracks">Show My Tracks</button>
    <div id="tracks" class="dropdown">
        <h2>Your Top 10 Tracks</h2>
        <ul id="track-list"></ul>
    </div>

    <button id="fetch-artists">Show My Artists</button>
    <div id="artists" class="dropdown">
        <h2>Your Top 10 Artists</h2>
        <ul id="artist-list"></ul>
    </div>

    <button id="fetch-soundtrack">Show Soundtrack of Your Life</button>
    <div id="soundtrack" class="dropdown">
        <h2>Your Soundtrack</h2>
        <ul id="soundtrack-list"></ul>
    </div>

    <!-- Now playing music -->
    <div id="now-playing-box" style="position: fixed; bottom: 20px; right: 20px; width: 320px; background-color: #282828; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.7); display: flex; padding: 12px; align-items: center; font-family: 'Arial', sans-serif; color: white; cursor: default; user-select: none; z-index: 1000; overflow: hidden;">
  <div id="blurred-bg" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; filter: blur(20px); opacity: 0.15; background-position: center; background-size: cover; z-index: 0; border-radius: 12px; transition: background-image 0.5s ease;"></div>
  <img id="now-playing-album-art" alt="Album Art" style="height: 60px; width: 60px; border-radius: 50%; object-fit: cover; background-color: #000; flex-shrink: 0; z-index: 2; animation: spin 20s linear infinite;" />
  <div id="now-playing-info" style="display: flex; flex-direction: column; justify-content: center; margin-left: 15px; overflow: hidden; position: relative; z-index: 2;">
    <div id="now-playing-track" style="font-weight: 700; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 240px; color: #1DB954;">Not Playing</div>
    <div id="now-playing-artist" style="font-size: 0.9rem; color: #B3B3B3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 240px; margin-top: 2px;"></div>
    <div id="now-playing-album" style="font-size: 0.85rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 240px; margin-top: 4px; font-style: italic;"></div>
  </div>
</div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>


    <!-- <button id="fetch-genres">Show My Genres</button>
    <div id="genres" class="dropdown">
        <h2>Your Top 10 Genres</h2>
        <ul id="genre-list"></ul>
    </div> -->

    <script>
        const toggleSection = (buttonId, sectionId, fetchUrl, listId, formatter) => {
            const button = document.getElementById(buttonId);
            const section = document.getElementById(sectionId);

            button.addEventListener('click', async () => {
                if (section.style.display === 'block') {
                    section.style.display = 'none';
                } else {
                    try {
                        // Fetch and populate data
                        const response = await fetch(fetchUrl);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch data from ${fetchUrl}`);
                        }
                        const data = await response.json();
                        const list = document.getElementById(listId);
                        list.innerHTML = ''; 

                        data.forEach(item => {
                            const li = document.createElement('li');
                            li.innerHTML = formatter(item);
                            list.appendChild(li);
                        });

                        section.style.display = 'block';
                    } catch (error) {
                        console.error(error);
                        section.innerHTML = `<p>Error fetching data</p>`;
                    }
                }
            });
        };

        // Define fetch logic for tracks and artists
        toggleSection('fetch-tracks', 'tracks', '/api/tracks', 'track-list', track => {
            return `<span class="track-name">${track.name}</span> by <span class="artist-name">${track.artist}</span>`;
        });

        toggleSection('fetch-artists', 'artists', '/api/artists', 'artist-list', artist => {
            return `<span class="artist-name">${artist.name}</span>`;
        });

        toggleSection('fetch-soundtrack', 'soundtrack', '/api/soundtrack', 'soundtrack-list', item => {
            return `<li><span class="track-name">${item.name}</span> by <span class="artist-name">${item.artist}</span> (${item.album})</li>`;
        });

        // Now Playing Bar
        async function updateNowPlaying() {
    try {
        const response = await fetch('/api/now-playing');
        if (!response.ok) throw new Error('Fetch failed');
        const data = await response.json();
        if (!data || !data.item || !data.is_playing) {
            displayNoMusic();
            return;
        }
        const track = data.item;
        const artists = track.artists.map(artist => artist.name).join(', ');
        const albumName = track.album.name || '';
        const albumArt = track.album.images[0]?.url || '';

        document.getElementById('now-playing-album-art').style.display = 'block';
        document.getElementById('now-playing-album-art').src = albumArt;
        document.getElementById('now-playing-track').textContent = track.name;
        document.getElementById('now-playing-artist').textContent = artists;
        document.getElementById('now-playing-album').textContent = albumName;
        document.getElementById('blurred-bg').style.backgroundImage = `url(${albumArt})`;
    } catch (error) {
        displayNoMusic();
    }
}

function displayNoMusic() {
    document.getElementById('now-playing-album-art').style.display = 'none';
    document.getElementById('now-playing-track').textContent = 'No music playing';
    document.getElementById('now-playing-artist').textContent = '';
    document.getElementById('now-playing-album').textContent = '';
}

updateNowPlaying();
setInterval(updateNowPlaying, 15000);

    // Fetch top tracks for a time range
    app.get('/api/top-tracks/:range', async (req, res) => {
    if (!req.user) return res.status(401).json({ message: 'Unauthorized' });

    const accessToken = req.user.accessToken;
    const timeRange = req.params.range; // 'short_term', 'medium_term', 'long_term'

    try {
        const response = await axios.get(`https://api.spotify.com/v1/me/top/tracks`, {
        headers: { Authorization: `Bearer ${accessToken}` },
        params: {
            time_range: timeRange,
            limit: 10
        }
        });

        const tracks = response.data.items.map(track => ({
        name: track.name,
        artist: track.artists.map(a => a.name).join(', '),
        album: track.album.name,
        image: track.album.images[0]?.url
        }));

        res.json(tracks);
    } catch (err) {
        console.error(err.response?.data || err);
        res.status(500).send('Failed to fetch top tracks');
    }
    });

    </script>
</body>
</html>
